#!/bin/bash

# uncomment one and exactly one of these  to make a key release or point release
# key releases are stored on target receivers, so partial sops can be diffed from them
# point releases are not stored on receivers, so psops _MUST NOT_ be diffed from them

if [ "$PWD" != "/builds/rxos/rxos" ]
then
    echo 'Releases MUST be built in /builds/rxos/rxos!'
    echo '  otherwise delta updates will be massive.'
    echo
    echo 'Stubbornly refusing to proceed. thbbt!'
    exit 1
fi

if [ -z "${KEY_RELEASE}" ]
then
    export KEY_RELEASE=no
else
    export KEY_RELEASE=yes
fi

# for uboot and ramfsinit
# date -u --date="2017-01-01" +%s
export SOURCE_DATE_EPOCH=1483228800

# for kernel and gen_initramfs
export KBUILD_BUILD_TIMESTAMP=2017-01-01
export KBUILD_BUILD_VERSION=1

# for busybox config
export KCONFIG_NOTIMESTAMP=1

# for mkuser
export MKPASSWD_SALT=mgfYRgrU

# for build timestamps
export RXOS_TIMESTAMP="$(date -u --rfc-3339=seconds)"

[ -d rxos/overlays ] || mkdir rxos/overlays/

if [ $# -gt  0 ]
then
time make BOARD=chip \
    RXOS_TIMESTAMP="\"$RXOS_TIMESTAMP\"" \
    KEY_RELEASE=$KEY_RELEASE \
    MKPASSWD_SALT=$MKPASSWD_SALT \
    KCONFIG_NOTIMESTAMP=$KCONFIG_NOTIMESTAMP \
    KBUILD_BUILD_VERSION=$KBUILD_BUILD_VERSION \
    KBUILD_BUILD_TIMESTAMP=$KBUILD_BUILD_TIMESTAMP \
    SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH \
    "$@"
echo "$@" done
else
time make BOARD=chip \
    RXOS_TIMESTAMP="\"$RXOS_TIMESTAMP\"" \
    KEY_RELEASE=$KEY_RELEASE \
    MKPASSWD_SALT=$MKPASSWD_SALT \
    KCONFIG_NOTIMESTAMP=$KCONFIG_NOTIMESTAMP \
    KBUILD_BUILD_VERSION=$KBUILD_BUILD_VERSION \
    KBUILD_BUILD_TIMESTAMP=$KBUILD_BUILD_TIMESTAMP \
    SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH \
    build release-flash
fi
